name: Convert Surge Module to Egern

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    
    steps:
    # 步骤 1: 设置 Node.js 环境
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'

    # 步骤 2: 安装依赖
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget curl
        sudo apt-get install -y libnss3 libgdk-pixbuf2.0-0 libx11-xcb1
        sudo apt-get install -y libxcomposite1 libxdamage1 libxi6
        sudo apt-get install -y libgconf-2-4
        sudo apt-get install -y libappindicator1 libasound2
        npm install puppeteer js-yaml

    # 步骤 3: 下载文件
    - name: Download Surge Module
      run: |
        mkdir -p /tmp/raw/
        wget -O /tmp/raw/official.sgmodule https://raw.githubusercontent.com/QingRex/LoonKissSurge/refs/heads/main/Surge/Official/%E7%BD%91%E6%98%93%E4%BA%91%E9%9F%B3%E4%B9%90%E5%8E%BB%E5%B9%BF%E5%91%8A.official.sgmodule

    # 步骤 4: 执行 Puppeteer 脚本转换模块
    - name: Run Puppeteer conversion script
      run: |
        mkdir -p /MODULES
        node <<EOF
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          const path = require('path');
          const yaml = require('js-yaml');
          
          (async () => {
            // 步骤 1: 启动 Puppeteer 浏览器实例
            const browser = await puppeteer.launch({ headless: true });
            const page = await browser.newPage();

            // 步骤 2: 读取文件内容
            const surgeModuleContent = fs.readFileSync('/tmp/raw/official.sgmodule', 'utf-8');

            // 步骤 3: 打开网页并进行模块转换
            await page.goto('https://gen.egernapp.com/');  // 转换网站
            await page.type('textarea[placeholder="Surge 模块"]', surgeModuleContent);
            
            // 等待转换完成并获取Egern模块内容
            await page.waitForSelector('textarea[readonly]');
            const egernModuleContent = await page.$eval('textarea[readonly]', el => el.value);

            // 步骤 4: 将转换后的内容保存为B.yaml
            const outputFilePath = path.resolve('/MODULES/converted_module.yaml');
            const egernYaml = yaml.dump(egernModuleContent);
            fs.writeFileSync(outputFilePath, egernYaml);

            // 步骤 5: 关闭浏览器
            await browser.close();
          })();
        EOF

    # 步骤 5: 删除临时文件夹
    - name: Clean up /tmp folder
      run: |
        rm -rf /tmp/raw/

    # 步骤 6: 上传转换后的文件 (使用 v2)
    - name: Upload converted file
      uses: actions/upload-artifact@v2  # 使用 v2 替换 v3
      with:
        name: converted_module
        path: /MODULES/converted_module.yaml
